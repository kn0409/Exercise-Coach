import streamlit as st
from openai import OpenAI

# --- 1. é¡µé¢é…ç½® ---
st.set_page_config(page_title="æ™ºèƒ½ç¤¾åŒºå¥åº·æŒ‡å¯¼å‘˜", page_icon="ğŸ©º")
st.title("ğŸ©º æ™ºèƒ½ç¤¾åŒºå¥åº·æŒ‡å¯¼å‘˜")
st.caption("æˆ‘ä¼šåƒåŒ»ç”Ÿä¸€æ ·è¯¢é—®æ‚¨çš„è¯¦ç»†æƒ…å†µï¼Œè¯·è€å¿ƒå›ç­”ã€‚")

# --- ä¿®æ”¹å‰ (è¿æ¥æœ¬åœ° Ollama) ---
# client = OpenAI(
#     base_url='http://localhost:11434/v1',
#     api_key='ollama', 
# )

# ä¿®æ”¹ä»£ç ï¼Œè®©å®ƒä»äº‘ç«¯çš„â€œä¿é™©ç®±â€é‡Œè¯»å–å¯†ç 
client = OpenAI(
    base_url='https://api.deepseek.com', 
    # st.secrets å°±åƒ R é‡Œçš„ç¯å¢ƒå˜é‡ï¼Œè‡ªåŠ¨è¯»å–ä½ åˆšæ‰å¡«åœ¨ç½‘é¡µä¸Šçš„å¯†ç 
    api_key=st.secrets["DEEPSEEK_API_KEY"], 
)


# --- 3. æ ¸å¿ƒä¿®æ”¹ï¼šå‡çº§ç‰ˆâ€œé—®è¯Šå‹â€äººè®¾ ---
# æˆ‘ä»¬ä½¿ç”¨ã€ã€‘ç¬¦å·æ¥å¼ºè°ƒé‡ç‚¹ï¼Œè®©æ¨¡å‹æ›´å¬è¯
SYSTEM_PROMPT = """
ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œã€è°¨æ…çš„ã€ç¤¾åŒºè¿åŠ¨å¥åº·æŒ‡å¯¼å‘˜ã€‘ã€‚
ä½ çš„ç›®æ ‡æ˜¯ä¸ºå±…æ°‘å¼€å…·è¿åŠ¨å¤„æ–¹ï¼Œä½†åœ¨å¼€å…·ä¹‹å‰ï¼Œä½ å¿…é¡»ç¡®ä¿ç»å¯¹å®‰å…¨ã€‚

ã€æ ¸å¿ƒå·¥ä½œæµç¨‹ã€‘
å½“ç”¨æˆ·æå‡ºå¥åº·é—®é¢˜ï¼ˆå¦‚â€œæˆ‘è†ç›–ç–¼â€ï¼‰æ—¶ï¼Œä½ ç»ä¸èƒ½ç›´æ¥ç»™å‡ºè¿åŠ¨å»ºè®®ï¼
ä½ å¿…é¡»æŒ‰ç…§ä»¥ä¸‹ã€æ£€æŸ¥æ¸…å•ã€‘è¿›è¡Œé€ä¸€è¿½é—®ï¼Œç›´åˆ°æ”¶é›†é½æ‰€æœ‰ä¿¡æ¯ï¼š

1. **å¹´é¾„**ï¼šåˆ¤æ–­èº«ä½“æœºèƒ½ã€‚
2. **ç–¼ç—›/ç—‡çŠ¶çš„å…·ä½“åŸå› **ï¼šæ˜¯å—è¿‡ä¼¤ï¼Ÿæ˜¯é€€è¡Œæ€§ç—…å˜ï¼Ÿè¿˜æ˜¯ä¸æ˜åŸå› ï¼Ÿ
3. **ç–¼ç—›ç¨‹åº¦**ï¼š1-10åˆ†ï¼Œç—›æ„Ÿå¼ºçƒˆï¼ˆ>6åˆ†ï¼‰å¿…é¡»å»ºè®®å°±åŒ»ï¼Œä¸èƒ½è¿åŠ¨ã€‚
4. **ç—…å²**ï¼šæ˜¯å¦æœ‰å¿ƒè„ç—…ã€é«˜è¡€å‹ã€ç³–å°¿ç—…ç­‰åŸºç¡€ç—…ã€‚

ã€äº¤äº’è§„åˆ™ã€‘
- **ä¸è¦ä¸€æ¬¡æ€§é—®æ‰€æœ‰é—®é¢˜**ï¼šåƒèŠå¤©ä¸€æ ·ï¼Œæ¯æ¬¡åªé—®1-2ä¸ªæœ€å…³é”®çš„é—®é¢˜ï¼Œä¿æŒäº²åˆ‡ã€‚
- **æ•æ‰å±é™©ä¿¡å·**ï¼šå¦‚æœç”¨æˆ·æåˆ°â€œå‰§çƒˆç–¼ç—›â€ã€â€œçº¢è‚¿å‘çƒ­â€ã€â€œèƒ¸ç—›â€ã€â€œå‘¼å¸å›°éš¾â€ï¼Œç«‹åˆ»åœæ­¢è¯¢é—®ï¼Œå¼ºåˆ¶å»ºè®®å»åŒ»é™¢ã€‚
- **ä»…åœ¨ä¿¡æ¯æ”¶é½å**ï¼šæ‰èƒ½æ ¹æ®ç”¨æˆ·æƒ…å†µç”Ÿæˆã€è¿åŠ¨å¤„æ–¹ã€‘ã€‚

ã€è¿åŠ¨å¤„æ–¹æ ‡å‡†æ ¼å¼ã€‘
(ä»…åœ¨æ‰€æœ‰ä¿¡æ¯æ”¶é›†å®Œæ¯•åè¾“å‡º)
### ğŸ“‹ æ‚¨çš„ä¸“å±è¿åŠ¨å¤„æ–¹
- **è¯Šæ–­åˆ¤æ–­**ï¼š[åŸºäºæ‚¨æä¾›çš„xxæƒ…å†µ...]
- **è¿åŠ¨ç›®æ ‡**ï¼š...
- **æ¨èé¡¹ç›®**ï¼š...
- **é¢‘ç‡å¼ºåº¦**ï¼š...
- **ç¦å¿ŒåŠ¨ä½œ**ï¼š[éå¸¸é‡è¦ï¼Œæ¯”å¦‚è†ç›–ç—›ç»å¯¹ä¸èƒ½çˆ¬å±±]
"""

# --- 4. åˆå§‹åŒ–èŠå¤©è®°å½• ---
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "system", "content": SYSTEM_PROMPT},
        {"role": "assistant", "content": "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„è¿åŠ¨å¥åº·æŒ‡å¯¼å‘˜ã€‚"}
    ]

# --- 5. å±•ç¤ºå†å²èŠå¤© ---
for msg in st.session_state.messages:
    if msg["role"] != "system":
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

# --- 6. å¤„ç†ç”¨æˆ·è¾“å…¥ ---
if user_input := st.chat_input("ä¾‹å¦‚ï¼šæˆ‘æœ€è¿‘è†ç›–æœ‰ç‚¹ç–¼..."):
    
    # æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
    with st.chat_message("user"):
        st.markdown(user_input)
    st.session_state.messages.append({"role": "user", "content": user_input})

    # AI ç”Ÿæˆå›å¤
    with st.chat_message("assistant"):
        message_placeholder = st.empty()
        full_response = ""
        
        # è°ƒç”¨æ¨¡å‹ (ä½¿ç”¨æµå¼è¾“å‡º)
        # --- ä¿®æ”¹æ¨¡å‹åç§° ---

        stream = client.chat.completions.create(
            model="deepseek-chat",
            messages=st.session_state.messages,
            temperature=0.6, # ç¨å¾®è°ƒä½æ¸©åº¦ï¼Œè®©ä»–æ›´ä¸¥è°¨ï¼Œä¸è¦å¤ªå‘æ•£
            stream=True,
        )
        
        for chunk in stream:
            if chunk.choices[0].delta.content is not None:
                full_response += chunk.choices[0].delta.content
                message_placeholder.markdown(full_response + "â–Œ")
        
        message_placeholder.markdown(full_response)
    
    # å­˜å…¥å†å²
    st.session_state.messages.append({"role": "assistant", "content": full_response})
